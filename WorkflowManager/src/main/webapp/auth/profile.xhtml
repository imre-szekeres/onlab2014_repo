<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:p="http://primefaces.org/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jsp/jstl/core">

	<ui:composition template="../WEB-INF/templates/wm_frame.xhtml">
	
	<ui:define name='content_title'>
		#{ profileManager.user.username }
	</ui:define>
	
	<ui:define name='content'>
		<h:form>
			<p:tabView dynamic='true' cache='true'>
				<p:tab title='Profile settings'>
					<c:choose>
						<c:when test='#{ profileManager.editable }'>
							<h:panelGrid columns='2'  cellpadding='5' id='profile_grid'  >
								<p:outputLabel value='Username' />
								<p:outputLabel value='#{ profileManager.user.username }'/>
								
								<p:outputLabel value='Email' for='email_input' />
								<p:inputText id='email_input' value='#{ profileManager.user.email }' validator='#{ profileManager.validateEmailIn }' />
								
								<p:outputLabel value='Description' for='description_input'/>
								<p:inputTextarea id='description_input' value='#{ profileManager.user.description }'  validator='#{ profileManager.validateDescriptionIn }' rows='5' cols='50'/>
							</h:panelGrid>
							
							<p:commandButton id='saveProfile_btn' value='Save' action='#{ profileManager.modify }' icon='ui-icon-check'/>
							<p:commandButton id='cancel_btn' value='Cancel' icon='ui-icon-cancel'/>
							<p:commandButton id='chpass_btn' value='Change password' icon='ui-icon-locked' onclick="PF('chpass_modal').show();"/>

							<p:dialog header="Change password" widgetVar="chpass_modal" modal="true" style='height:300px; width:100px;'>
								<h:panelGrid id='chpass_grid' columns='2'  cellspacing='5' cellpadding='5' >
									<p:outputLabel value='Old password' for='old_password'/>
									<p:password id='old_password' value='#{ profileManager.oldPassword }' validator='#{ profileManager.validateOldPassword }'/> 
									
									<p:outputLabel value='New password' for='new_password' />
									<p:password id='new_password' value='#{ profileManager.newPassword }' match='new_password_again' feedback='true' required='true' validator='#{   profileManager.validateNewPassword }' />
									
									<p:outputLabel value='Confirm new password' for='new_password_again' />
									<p:password id='new_password_again' value='#{ profileManager.newPassword }' feedback='true' required='true' validator='#{   profileManager.validateNewPassword }'/>
								</h:panelGrid>
								
								<p:commandButton id='saveChpass_btn' value='Save' update='chpass_grid' action='#{ profileManager.modify }' icon='ui-icon-check'/>
							</p:dialog> 
						
						</c:when>
						<c:otherwise>
							<h:panelGrid id='profile_grid' columns='2'  cellspacing='1' cellpadding='2' >
								<h:outputText value='Username: ' />
								<h:outputText value='#{ profileManager.user.username }' />
								<h:outputText value='Email: ' />
								<h:outputText value='#{ profileManager.user.email }' />
								<h:outputText value='Description: ' />
								<h:inputTextarea value='#{ profileManager.user.description }' readonly='true' styleClass='inputTextAreaClass'/>
							</h:panelGrid>
						</c:otherwise>
					</c:choose>
				</p:tab>
				
				<p:tab title='My roles'>
					<p:dataList value="#{profileManager.listRoles()}" var="role" type="definition">
						<h:outputText value="#{role.name}"  style="margin-left:10px;"/>
					</p:dataList>
					<c:if test="#{ sessionScope.subject.hasRole('administrator') }" >
						<p:commandButton id='add_role_btn' value='Add Role' onclick="PF('add_role_modal').show();"/>
						<p:dialog header="Change password" widgetVar="add_role_modal" modal="true" style='height:300px; width:100px;'>
							<h:panelGrid id='role_panel' columns='2'>
								<p:selectOneMenu id='select_one_role' value='#{ profileManager.role }' styleClass='selectMenu'>
									<c:forEach items='#{ loginManager.listRoleNames() }' var='roleName' >
										<f:selectItem itemLabel='#{ roleName }' itemValue='#{ roleName }' />
									</c:forEach>
								</p:selectOneMenu>
								<p:commandButton value='Add' action='#{ profileManager.addRole() }'/>
							</h:panelGrid>
						</p:dialog>
					</c:if>
				</p:tab>
				
				<p:tab title='My projects'>
					<h:outputText value='Assigned Projects' />
					<p:dataList id='assigned_projects_table' value="#{ profileManager.listAssignments() }" var='assignment'>
						<h:column>
							<h:commandLink value='#{ assignment.project.name }' action='#{ projectManager.profileOf( assignment.project ) }' />
						</h:column>
					</p:dataList>
				</p:tab>
				
				<p:tab title='My comments'>
					<p:dataList id='comment_table' value='#{ commentManager.listCommentsOf( profileManager.user ) }' var='comment'>
							<h:outputText value='Commented on' />
							<h:commandLink value='#{ comment.project.name }' action='#{ projectManager.profileOf( comment.project ) }' />
							<h:outputText value=' at ' />
							<h:outputText  value='#{ comment.postDate }' disabled='true'>
								<f:convertDateTime pattern='yyyy.MM.dd HH:mm' />
							</h:outputText >
					</p:dataList>
				</p:tab>
			</p:tabView>
		</h:form>
	</ui:define>
	
	</ui:composition>
</html>